import
    std/[json, os, db_sqlite, strformat, re, locks],
    youtubescraper

var 
    kwords: array[0..6, string] = [
        "discord token generator", "discord nitro generator", 
        "discord mass joiner", "discord tools", "hypixel skyblock mods", 
        "hypixel skyblock macro", "hypixel skyblock qol macro"
    ]
    cock: Lock
    scrape_T: array[0..high(kwords), Thread[string]]
proc createDB: void =
    let db = open("malware.db", "", "", "")
    db.exec(sql"""CREATE TABLE IF NOT EXISTS malwares (
        video_id TEXT NOT NULL,
        channel TEXT NOT NULL,
        malware_link TEXT NOT NULL,
        discord_link TEXT NOT NULL,
        PRIMARY KEY (malware_link)
    )""")

proc addMalware(
    video_id: string, channel: string, 
    malware_link: string, discord_link: string): void =
    let db = open("malware.db", "", "", "")
    try:
        db.exec(sql(fmt"""INSERT INTO malwares (
            video_id, channel, 
            malware_link, discord_link
        ) VALUES (
            ?, ?, ?, ?
        )"""), video_id, channel, malware_link, discord_link)
    except DbError:
        discard

proc main(keyword: string) {.thread.} =
    acquire(cock)
    let 
        vids = getVideos(keyword, SearchOptions.soUploadDate)
        DISCORD_TELEGRAM_REGEX = re(r"(?i)(?<!\S)(?:(?:https?://)?(?:www\.)?(?:discord\.gg|discordapp\.com/invite)/\S+|t\.me/\S+)(?!\S)")
        FILEUPLOADLIST: seq[Regex] = @[
            re(r"(www\.)?mediafire\.com/file/[a-zA-Z0-9]{15}/[a-zA-Z0-9]+\.[a-zA-Z]+/file"),
            re(r"(drive\.google\.com/file/d/[a-zA-Z0-9]+)"),
            re(r"(linkvertise\.com/[a-zA-Z0-9]+)"),
            re(r"(linkshrink\.net/[a-zA-Z0-9]+)"),
            re(r"(linkspl\.it/[a-zA-Z0-9]+)"),
            re(r"(adf\.ly/[a-zA-Z0-9]+)"),
            re(r"(adfoc\.us/[a-zA-Z0-9]+)"),
            re(r"(tinyurl\.com/[a-zA-Z0-9]+)"),
            re(r"(bit\.ly/[a-zA-Z0-9]{7})"),
            re(r"(anonfiles\.com/[a-zA-Z0-9]+)"),
            re(r"(file-upload\.com/[a-zA-Z0-9]+)"),
            re(r"(filebebo\.com/[a-zA-Z0-9]+)"),
            re(r"(filebin\.net/[a-zA-Z0-9]+)"),
            re(r"(filefactory\.com/[a-zA-Z0-9]+)"),
            re(r"(filehoot\.com/[a-zA-Z0-9]+)"),
            re(r"(filejoker\.net/[a-zA-Z0-9]+)"),
            re(r"(filepup\.net/[a-zA-Z0-9]+)"),
            re(r"(files\.cdn\.com/[a-zA-Z0-9]+)"),
            re(r"(gofile\.io/d/[a-zA-Z0-9]+)"),
            re(r"(mega\.nz/[a-zA-Z0-9]+)"),
            re(r"(megaup\.net/[a-zA-Z0-9]+)"),
            re(r"(megaupload\.com/[a-zA-Z0-9]+)"),
            re(r"(megazip\.net/[a-zA-Z0-9]+)"),
            re(r"(megadown\.net/[a-zA-Z0-9]+)"),
            re(r"(megadownloader\.net/[a-zA-Z0-9]+)"),
            re(r"(cdn\.discordapp\.com/attachments/[0-9]{19}/[a-zA-Z0-9]+\.([a-zA-Z]+))"),
            re(r"(media\.discordapp\.net/attachments/[0-9]{19}/[a-zA-Z0-9]+\.([a-zA-Z]+))"),
            re(r"(dropbox\.com\/s\/[a-z0-9]{15,}\/[^\s\/]+\/?)"),
            re(r"(we\.tl\/[a-zA-Z0-9]{10}(-[a-zA-Z0-9]{10})?)")
        ]
    for video in vids:
        try:
            var
                details = getVideoInfo(video.videoId)
                title = details.title
                description = details.description
                channel = details.channelUrl
                discordortelegram = findAll(description, DISCORD_TELEGRAM_REGEX)
                files: seq[string] = @[]
            for reg in FILEUPLOADLIST:
                for f in description.findAll(reg):
                    files.add(f)
            if discordortelegram.len > 0 or files.len > 0:
                addMalware(video.videoId, channel, $ %files, $ %discordortelegram)
                echo "ID: ", video.videoId
                echo "Title: ", title
                echo "Channel: ", channel
                echo "Discord or Telegram: ", discordortelegram
                echo "Files: ", files
                echo "-------------------"
        except:
            discard
    release(cock)
    
initLock(cock)

discard execShellCmd(when defined(windows): "cls" else: "clear")

createDB()
for i in 0..high(scrape_T):
    createThread(scrape_T[i], main, (kwords[i]))
joinThreads(scrape_T)

deinitLock(cock)